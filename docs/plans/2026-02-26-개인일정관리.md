# 개인 일정 관리 워크플로우 구현 계획

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** 텔레그램으로 자연어 일정을 등록하고, Google Calendar에 저장하고, 매일 아침 브리핑 + 1시간 전 리마인더를 텔레그램으로 받는 n8n 워크플로우 시스템을 구축한다.

**Architecture:** 3개의 독립 워크플로우로 구성한다.

| 워크플로우 | 트리거 | 역할 |
|---|---|---|
| WF1: 일정 등록 | Telegram Trigger | 자연어 → AI 파싱 → Google Calendar 저장 → 확인 응답 |
| WF2: 아침 브리핑 | Schedule Trigger (매일 아침) | 오늘/7일/30일 일정 조회 → 포맷팅 → 텔레그램 전송 |
| WF3: 1시간 전 리마인더 | Schedule Trigger (매 30분) | 다가오는 일정 조회 → 필터 → 텔레그램 알림 |

**Tech Stack:** n8n 워크플로우, Google Calendar API, Telegram Bot API, AI 노드 (자연어 파싱)

---

## 사전 준비 (워크플로우 구성 전에 완료)

실행자가 직접 준비해야 하는 외부 서비스:

### 1. Telegram Bot
- 기존 봇을 재사용하거나 [@BotFather](https://t.me/BotFather)에서 새 봇 생성
- Bot Token과 chat_id 확인
- n8n에 Telegram API credential 등록 확인

### 2. Google Calendar API
- n8n에 Google Calendar OAuth2 credential 등록
- 사용할 캘린더 ID 확인 (기본: primary)

### 3. AI credential
- n8n에 OpenAI 또는 Anthropic credential 등록 확인 (자연어 파싱용)

---

## WF1: 일정 등록 워크플로우

### 노드 구성

```
Telegram Trigger → AI Agent (자연어 파싱) → Google Calendar (이벤트 생성) → Telegram (확인 응답)
```

### Task 1-1: 워크플로우 생성

```javascript
n8n_create_workflow({
  name: "개인 일정 등록",
  nodes: [
    // Telegram Trigger - 메시지 수신
    // AI Agent - 자연어를 날짜/시간/제목으로 파싱
    // Google Calendar - 이벤트 생성
    // Telegram - 등록 확인 응답
  ]
})
```

### Task 1-2: Telegram Trigger 노드

사용자가 보낸 텍스트 메시지를 수신한다.

### Task 1-3: AI Agent 노드 (자연어 파싱)

사용자 메시지에서 일정 정보를 추출한다. 시스템 프롬프트:

```
당신은 일정 파싱 도우미입니다. 사용자의 자연어 메시지에서 일정 정보를 추출하세요.

오늘 날짜: {{현재 날짜}}

반드시 아래 JSON 형식으로만 응답하세요:
{
  "title": "일정 제목",
  "date": "YYYY-MM-DD",
  "startTime": "HH:mm",
  "endTime": "HH:mm",
  "allDay": false
}

규칙:
- "다음 주 화요일" 같은 상대 날짜를 오늘 기준으로 계산
- 종료 시간이 없으면 시작 시간 + 1시간
- 시간이 없으면 allDay: true, startTime/endTime은 null
- "오후 3시" → "15:00"
```

### Task 1-4: Code 노드 (JSON 파싱)

AI 응답에서 JSON을 추출한다.

```javascript
const aiResponse = $json.text || $json.output || '';
const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
if (!jsonMatch) throw new Error('일정 정보를 파싱할 수 없습니다');
const parsed = JSON.parse(jsonMatch[0]);
return [{ json: parsed }];
```

### Task 1-5: Google Calendar 노드 (이벤트 생성)

파싱된 정보로 Google Calendar 이벤트를 생성한다.

- Operation: Create Event
- Calendar: primary
- Title: `={{ $json.title }}`
- Start: 파싱된 날짜/시간
- End: 파싱된 종료 시간

### Task 1-6: Telegram 확인 응답 노드

등록 완료를 사용자에게 알린다.

```
✅ 일정 등록 완료

📌 <제목>
📅 <날짜>
🕒 <시간>
```

### Task 1-7: 검증 및 테스트

```javascript
n8n_validate_workflow({ id: "<WF1 ID>" })
n8n_test_workflow({ id: "<WF1 ID>" })
```

---

## WF2: 매일 아침 브리핑 워크플로우

### 노드 구성

```
Schedule Trigger (매일 아침) → Google Calendar (오늘) → Google Calendar (7일) → Google Calendar (30일) → Code (포맷팅) → Telegram (브리핑 전송)
```

### Task 2-1: 워크플로우 생성

```javascript
n8n_create_workflow({
  name: "일정 아침 브리핑",
  nodes: [
    // Schedule Trigger - 매일 아침 8시 (KST)
    // Google Calendar - 오늘 일정 조회
    // Google Calendar - 7일 일정 조회
    // Google Calendar - 30일 일정 조회
    // Code - 3개 결과를 하나의 브리핑 메시지로 포맷팅
    // Telegram - 브리핑 전송
  ]
})
```

### Task 2-2: Schedule Trigger

매일 아침 8시(KST) 실행. n8n 인스턴스 타임존에 따라 시간 조정.

### Task 2-3: Google Calendar 조회 노드 3개

각각 다른 기간의 일정을 가져온다:
- 노드 A: timeMin=오늘 00:00, timeMax=오늘 23:59 (오늘)
- 노드 B: timeMin=오늘, timeMax=오늘+7일 (7일간)
- 노드 C: timeMin=오늘, timeMax=오늘+30일 (30일간)

### Task 2-4: Code 노드 (브리핑 포맷팅)

3개 조회 결과를 합쳐서 브리핑 메시지를 구성한다.

예상 메시지:

```
📋 2월 26일 (목) 아침 브리핑

📌 오늘의 일정
• 15:00 치과 검진
• 19:00 저녁 약속

📅 이번 주 (7일)
• 2/27 (금) 10:00 팀 미팅
• 3/1 (토) 종일 - 삼일절

🗓️ 한 달 내 (30일)
• 3/5 (수) 14:00 건강검진
• 3/15 (토) 종일 - 친구 결혼식

일정 없음 → "예정된 일정이 없습니다 ☀️"
```

### Task 2-5: Telegram 전송 노드

포맷팅된 브리핑 메시지를 전송한다.
- parse_mode: HTML
- chat_id: 사용자 chat ID

### Task 2-6: 검증 및 테스트

```javascript
n8n_validate_workflow({ id: "<WF2 ID>" })
n8n_test_workflow({ id: "<WF2 ID>" })
```

---

## WF3: 1시간 전 리마인더 워크플로우

### 노드 구성

```
Schedule Trigger (매 30분) → Google Calendar (다가오는 일정) → Code (필터 + 포맷) → IF (알릴 일정 있음?) → Telegram (리마인더 전송)
```

### Task 3-1: 워크플로우 생성

```javascript
n8n_create_workflow({
  name: "일정 1시간 전 리마인더",
  nodes: [
    // Schedule Trigger - 매 30분
    // Google Calendar - 45~75분 후 시작하는 일정 조회
    // Code - 필터링 + 리마인더 메시지 포맷팅
    // IF - 알릴 일정이 있는지 확인
    // Telegram - 리마인더 전송
  ]
})
```

### Task 3-2: Schedule Trigger

매 30분마다 실행 (매시 :00, :30).

### Task 3-3: Google Calendar 조회

- timeMin: now + 45분
- timeMax: now + 75분
- 이 윈도우로 각 일정이 한 번만 잡힌다 (30분 주기 × 30분 윈도우 = 중복 없음)

### Task 3-4: Code 노드 (필터 + 포맷)

종일 일정(allDay)은 제외하고, 시간 지정 일정만 리마인더를 보낸다.

예상 메시지:

```
⏰ 1시간 후 일정 알림

📌 치과 검진
🕒 15:00
```

### Task 3-5: IF 노드

알릴 일정이 없으면 Telegram 전송을 건너뛴다.

### Task 3-6: Telegram 전송 노드

리마인더 메시지를 전송한다.

### Task 3-7: 검증 및 테스트

```javascript
n8n_validate_workflow({ id: "<WF3 ID>" })
n8n_test_workflow({ id: "<WF3 ID>" })
```

---

## 전체 활성화

3개 워크플로우 모두 테스트 통과 후 활성화:

```javascript
// WF1, WF2, WF3 각각
n8n_update_partial_workflow({
  id: "<워크플로우 ID>",
  intent: "워크플로우 활성화",
  operations: [{ type: "activateWorkflow" }]
})
```

---

## 주의사항 (n8n-gotchas 참조)

- `updateNode`는 전체 parameters를 보내야 함 (merge 아님)
- 한국어 노드 이름 → nodeId 사용 권장
- Telegram callback_data는 `additionalFields.callback_data` (snake_case)
- Schedule Trigger는 인스턴스 타임존 기준
- Google Calendar 노드의 시간은 ISO 8601 형식

---

## 예상 사용 흐름

1. 사용자: 텔레그램에 "다음 주 화요일 오후 3시에 치과" 전송
2. WF1: AI가 파싱 → Google Calendar에 3/3(화) 15:00 "치과" 등록 → "✅ 일정 등록 완료" 응답
3. WF2: 매일 아침 8시에 오늘/7일/30일 브리핑 자동 전송
4. WF3: 3/3(화) 14:00에 "⏰ 1시간 후: 치과" 리마인더 전송
