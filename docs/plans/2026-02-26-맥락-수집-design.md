# Linear/GitHub 개인 맥락 자동 수집 시스템 설계

## 배경

AI에게 작업을 맡길 때 나의 전체 맥락(직무, 진행 중인 프로젝트, 처리 중인 이슈, 해왔던 일, 해야 할 일)이 주입되지 않아 원하는 결과를 얻지 못하는 문제. 이번에는 "맥락 수집"에만 초점을 맞추고, "맥락 주입"은 별도 문제로 분리한다.

## 전체 아키텍처

Push 방식: Linear/GitHub 웹훅 이벤트 발생 → n8n이 자동 수집하여 PostgreSQL에 저장 → Claude Code가 MCP 도구로 저장된 맥락 조회.

```
[Linear 웹훅] ──→ [n8n: WF1 수집] ──→ [PostgreSQL]
[GitHub 웹훅] ──→ [n8n: WF2 수집] ──→ [PostgreSQL]
                                            ↑
[Claude Code] ──→ [n8n MCP: WF3 조회] ─────┘
```

맥락은 시간축으로 누적되어, "현재 상태" 뿐 아니라 "무엇을 해왔는가"의 히스토리를 제공한다.

## 수집 이벤트 및 데이터

### Linear

| 이벤트 | 수집 데이터 | 의미 |
|---|---|---|
| Issue 생성/업데이트 | 제목, 상태, 담당자, 프로젝트, 우선순위, 라벨 | 내 이슈 현황 |
| Issue 상태 변경 | 이전 상태 → 새 상태, 변경 시각 | 작업 흐름 추적 |
| 사이클/프로젝트 변경 | 사이클 목표, 진행률 | 팀/프로젝트 전체 흐름 |

### GitHub

| 이벤트 | 수집 데이터 | 의미 |
|---|---|---|
| PR 생성/업데이트/머지 | 제목, 브랜치, 상태, 리뷰어, 변경 파일 | 내 코드 작업 현황 |
| Push (커밋) | 커밋 메시지, 변경 파일 수 | 최근 작업 내용 |
| PR 리뷰/코멘트 | 리뷰 내용, 상태 | 피드백 추적 |

## 저장소

Coolify에서 PostgreSQL 인스턴스를 운영한다. 단일 테이블에 JSONB `metadata` 컬럼으로 이벤트별 상세 데이터를 유연하게 저장.

### 테이블 구조

```sql
CREATE TABLE context_events (
    id SERIAL PRIMARY KEY,
    source VARCHAR(20) NOT NULL,        -- 'linear' | 'github'
    event_type VARCHAR(50) NOT NULL,    -- 'issue_updated', 'pr_created', ...
    entity_id VARCHAR(100) NOT NULL,    -- 이슈 ID, PR 번호 등
    title TEXT,
    status VARCHAR(50),
    metadata JSONB,                     -- 이벤트별 추가 데이터
    actor VARCHAR(100),                 -- 담당자/작성자
    project VARCHAR(100),               -- 프로젝트/레포 이름
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(source, entity_id)           -- 같은 엔티티는 UPSERT
);
```

## MCP 조회 인터페이스

n8n 워크플로우로 구현하여 기존 n8n MCP 서버를 통해 노출.

| 도구 이름 | 입력 | 반환 | 용도 |
|---|---|---|---|
| `get_my_context` | `source?`, `days?` | 최근 N일간의 Linear 이슈 + GitHub PR/커밋 요약 | 전체 맥락 조회 |
| `get_linear_issues` | `status?`, `project?` | 조건에 맞는 Linear 이슈 목록 | Linear 집중 조회 |
| `get_github_activity` | `repo?`, `days?` | 최근 PR/커밋 활동 | GitHub 집중 조회 |

반환 형식: Claude Code가 바로 이해할 수 있도록 자연어 요약 형태의 Markdown 문자열.

## 워크플로우 구성 (3개)

### WF1: Linear 이벤트 수집
```
[Linear 웹훅] → [이벤트 파싱 (Code)] → [PostgreSQL UPSERT]
```
- 트리거: Linear 웹훅 (이슈 생성/업데이트/상태변경, 프로젝트/사이클 변경)
- 처리: 이벤트 데이터를 context_events 테이블 형식으로 정규화
- 저장: PostgreSQL UPSERT (같은 entity_id면 업데이트)

### WF2: GitHub 이벤트 수집
```
[GitHub 웹훅] → [이벤트 파싱 (Code)] → [PostgreSQL UPSERT]
```
- 트리거: GitHub 웹훅 (PR 생성/업데이트/머지, Push, PR 리뷰)
- 처리: 이벤트 데이터를 context_events 테이블 형식으로 정규화
- 저장: PostgreSQL UPSERT

### WF3: 맥락 조회 (MCP 인터페이스)
```
[MCP 요청] → [PostgreSQL 쿼리] → [Markdown 포맷팅 (Code)] → [응답 반환]
```
- 트리거: n8n MCP 서버를 통한 도구 호출
- 쿼리: source, status, days 등 파라미터로 필터링
- 포맷팅: 조회 결과를 Markdown 요약으로 변환하여 반환

## 성공 기준

1. Linear에서 이슈를 생성/변경하면 n8n이 자동으로 수집하여 PostgreSQL에 저장된다
2. GitHub에서 PR/커밋을 하면 n8n이 자동으로 수집하여 PostgreSQL에 저장된다
3. Claude Code 세션에서 MCP 도구로 맥락을 조회하면 Markdown 요약이 반환된다
